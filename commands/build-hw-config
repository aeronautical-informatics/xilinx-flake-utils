#!/usr/bin/env bash

UTILS_ROOT=$( cd "$(dirname -- "${BASH_SOURCE[0]}")"/.. && pwd )
source "$UTILS_ROOT/commands/lib.sh"

help()
{   
log usage "build-hw-config [Arguments] [Options]
Arguments:        
    DIR         directory of hardware configuration project

Options:   
    -c, --carrier CARRIER    devboard, fcc"
}

if [[ $# -eq 0 ]]
then
  help
fi

POSITIONAL=() 
while [[ $# -gt 0 ]]; do
  case $1 in
    -c|--carrier)
        CARRIER=$2
        shift 2
        ;;
    -h|--help)
        help
        ;;
    *)
        POSITIONAL+=($1)
        shift
        ;;
  esac
done

set -- "${POSITIONAL[@]}"

_ensure-exists dir DIR "$1"
_ensure-exists file PROJ_FILE "$DIR/workspace/"*.xpr
_ensure-exists file PROJ_CFG "$DIR/project.cfg"
_mkdir-if-missing "$DIR/hardware_configuration"

NAME=$(grep "name=" "$PROJ_CFG" | cut -d'=' -f2)
PLATFORM=$(grep "platform=" "$PROJ_CFG" | cut -d'=' -f2)

case "$PLATFORM" in 
    "zynq7000"|"ultrascale")
        case "$CARRIER" in 
            "devboard"|"fcc")
                ;;
            "")
                log error "please specify a carrier board: devboard, fcc"
                help
                return 1
                ;;
            *)
                log error "unsupported carrier $CARRIER" 1
                ;;
        esac
        ;;
    "zedboard"|"coraz7")
        CARRIER="$PLATFORM"
        ;;
    *)
        log error "unsupported platform $PLATFORM" 1
        ;;
esac

pushd "$DIR" || return 1
    sed -i "s/%carrier/"$CARRIER"/g" "./project.cfg"
popd

vivado -nolog -nojournal -mode batch \
    -source "$UTILS_ROOT/tcl-lib/vivado_all.tcl" "$PROJ_FILE" \
    -tclargs "$DIR" "$DIR/hardware_configuration" "$CARRIER"

unzip "${DIR}/hardware_configuration/${CARRIER}_hw.xsa" -d "${DIR}/hardware_configuration/extract_tmp"

case "$PLATFORM" in
    "zynq7000"|"zedboard"|"coraz7")
        cp --force "${DIR}/hardware_configuration/extract_tmp/ps7_init.tcl" "${DIR}/hardware_configuration/"
        # TODO: copy hwh file to "hardware_configuration" dir
        ;;
    "ultrascale")        
        cp --force "${DIR}/hardware_configuration/extract_tmp/psu_init.tcl" "${DIR}/hardware_configuration/"        
        cp --force "${DIR}/workspace/"$NAME".srcs/sources_1/bd/"$NAME"_BD/hw_handoff/"$NAME"_BD.hwh" "${DIR}/hardware_configuration/"$CARRIER".hwh"
        ;;
    *)
        log error "unsupported platform $PLATFORM" 1
        ;;
esac

rm -r "${DIR}/hardware_configuration/extract_tmp"
